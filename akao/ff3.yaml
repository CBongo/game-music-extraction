game: "Final Fantasy III US / VI JP (SNES)"
format: "snes_unified"
console_type: "snes"

# SNES ROM file
rom_file: "f_fan3.fig"

# Base address for song data (SNES address C5/0000 - HiROM)
base_address: 0xC50000

# Song pointer table configuration
song_pointer_table:
  style: "direct"  # FF3 uses direct pointers (vs FF2's indirection table)
  offset: 0x3E96   # Offset from base_address
  count: 85        # Number of songs

has_alternate_voice_pointers: true  # Some songs have alternate versions

# Instrument table configuration
instrument_table_offset: 0x3F95  # Offset from base_address for instrument tables

# Instrument mapping configuration
instrument_mapping:
  type: "dual_map"
  param: 0x20

# PHASE 1: Config-driven parameters for SNESUnified
spc_load_address: 0x1C00   # SPC-700 RAM load address (different from FF2's 0x2000)
note_divisor: 14           # Note encoding: note = cmd / 14, duration = cmd % 14 (different from FF2's 15)
first_opcode: 0xC4         # First command opcode (< 0xC4 are notes, different from FF2's 0xD2)

# Voice addressing formula for FF3
vaddroffset_formula:
  type: "subtract_constant"
  constant: 0x11C24

# PHASE 2: Opcode dispatch table - maps opcode bytes to semantic meanings
# FF3 uses different opcode values than FF2
opcodes:
  0xC4: {semantic: "volume"}          # Voice volume (single operand, immediate)
  0xC5: {semantic: "volume_fade"}     # Volume fade (per ff3mus.pl line 43)
  0xC6: {semantic: "pan"}             # Balance/Pan (per ff3mus.pl line 44)
  0xC7: {semantic: "pan_fade"}        # Balance/Pan fade (per ff3mus.pl line 44)
  0xC8: {semantic: "portamento_on"}   # Portamento settings
  0xC9: {semantic: "vibrato_on"}      # Vibrato settings
  0xCA: {semantic: "vibrato_off"}     # Vibrato off
  0xCB: {semantic: "tremolo_on"}      # Tremolo settings
  0xCC: {semantic: "tremolo_off"}     # Tremolo off
  0xCD: {semantic: "pan_sweep"}       # Pan Sweep (per ff3mus.pl line 46)
  0xCE: {semantic: "pan_sweep_off"}  # Pan Sweep off
  0xCF: {semantic: "noise_clock"}     # Set Noise Clock (per ff3mus.pl line 47)
  0xD0: {semantic: "noise_on"}        # Enable Noise (per ff3mus.pl line 48)
  0xD1: {semantic: "noise_off"}       # Disable Noise (per ff3mus.pl line 48)
  0xD2: {semantic: "pitchmod_on"}     # Enable Pitchmod (per ff3mus.pl line 49)
  0xD3: {semantic: "pitchmod_off"}    # Disable Pitchmod (per ff3mus.pl line 49)
  0xD4: {semantic: "echo_on"}         # Enable Echo (per ff3mus.pl line 50)
  0xD5: {semantic: "echo_off"}        # Disable Echo (per ff3mus.pl line 50)
  0xD6: {semantic: "octave_set"}      # Set octave
  0xD7: {semantic: "octave_inc"}      # Increment octave
  0xD8: {semantic: "octave_dec"}      # Decrement octave
  0xD9: {semantic: "transpose_set"}   # Set Transpose (per ff3mus.pl line 52)
  0xDA: {semantic: "transpose_change"}  # Change Transpose (per ff3mus.pl line 52)
  0xDB: {semantic: "detune"}          # Detune (per ff3mus.pl line 53)
  0xDC: {semantic: "patch_change"}  # Patch change (uses instrument_mapping)
  0xDD: {semantic: "adsr_attack"}     # Set ADSR Attack (per ff3mus.pl line 54)
  0xDE: {semantic: "adsr_decay"}      # Set ADSR Decay (per ff3mus.pl line 54)
  0xDF: {semantic: "adsr_sustain"}    # Set ADSR Sustain (per ff3mus.pl line 55)
  0xE0: {semantic: "adsr_release"}    # Set ADSR Release (per ff3mus.pl line 55)
  0xE1: {semantic: "adsr_default"}    # Set Default ADSR (per ff3mus.pl line 56)
  0xE2: {semantic: "loop_start"}      # Begin repeat
  0xE3: {semantic: "loop_end"}        # End repeat
  0xE4: {semantic: "slur_on"}         # Begin Slur (per ff3mus.pl line 57)
  0xE5: {semantic: "slur_off"}        # End Slur (per ff3mus.pl line 57)
  0xE6: {semantic: "roll_on"}         # Begin Roll (per ff3mus.pl line 58)
  0xE7: {semantic: "roll_off"}        # End Roll (per ff3mus.pl line 58)
  0xE8: {semantic: "utility_duration"}    # Utility Duration (per ff3mus.pl line 58)
  0xE9: {semantic: "play_sfx"}        # Play SFX (E9) (per ff3mus.pl line 59)
  0xEA: {semantic: "play_sfx"}        # Play SFX (EA) (per ff3mus.pl line 59)
  0xEB: {semantic: "halt"}            # Halt
  0xEC: {semantic: "halt"}            # Halt
  0xED: {semantic: "halt"}            # Halt
  0xEE: {semantic: "halt"}            # Halt
  0xEF: {semantic: "halt"}            # Halt
  0xF0: {semantic: "tempo"}           # Tempo change (operand 0 = tempo value)
  0xF1: {semantic: "tempo_fade"}      # Tempo fade (per ff3mus.pl line 267)
  0xF2: {semantic: "echo_volume"}     # Set Echo Volume (per ff3mus.pl line 61)
  0xF3: {semantic: "echo_volume_fade"}  # Fade Echo Volume (per ff3mus.pl line 61)
  0xF4: {semantic: "volume_multiplier"}  # Set Volume Multiplier (per ff3mus.pl line 61)
  0xF5: {semantic: "loop_break", handler: "vaddroffset"}  # Conditional loop with vaddroffset
  0xF6: {semantic: "goto", handler: "vaddroffset"}        # Goto with vaddroffset
  0xF7: {semantic: "echo_feedback_fade"}  # Set/Fade Echo Feedback (per ff3mus.pl line 64)
  0xF8: {semantic: "filter_fade"}     # Set/Fade Filter (per ff3mus.pl line 65)
  0xF9: {semantic: "advance_cue"}     # Advance Cue Point (per ff3mus.pl line 65)
  0xFA: {semantic: "zero_cue"}        # Zero Cue Point (per ff3mus.pl line 66)
  0xFB: {semantic: "ignore_volume_mult"}  # Ignore Volume Multiplier (per ff3mus.pl line 66)
  0xFC: {semantic: "branch_if_dd"}    # Branch if $DD (per ff3mus.pl line 67)
  0xFD: {semantic: "halt"}            # Halt
  0xFE: {semantic: "halt"}            # Halt
  0xFF: {semantic: "halt"}            # Halt

# Tempo calculation parameters
# BPM is calculated as: BPM = (60,000,000 * tempo_value) / tempo_factor
# where tempo_factor = timer_period_us * timer_count * tempo_resolution
timer_period_us: 4875     # Timer period in microseconds (timer0 period: 4.875ms)
timer_count: 48           # Number of timer counts per sound processing loop
tempo_resolution: 256     # 8-bit tempo operands (range 0-255)

# Default state values
default_tempo: 120
default_octave: 4
default_velocity: 100

# Duration table - 14 entries (vs 15 for FF2)
duration_table:
  address: 0xC51CE1  # spcbase + 0x17d1 where spcbase = C5/0510
  size: 14
  type: "byte"

# Music opcode lengths - 60 opcodes starting from 0xC4
opcode_table:
  address: 0xC51E09  # spcbase + 0x18f9 where spcbase = C5/0510
  size: 60
  type: "byte"

# Pitch table
pitch_table:
  address: 0xC51C9F  # spcbase + 0x178f where spcbase = C5/0510
  size: 13
  type: "ushort"

# Patch mapping: instrument_id -> General MIDI patch
# Negative values indicate percussion (GM drum key number)
patch_map:
  0x00: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  0x01: {gm_patch: 24, transpose: 0, name: "Acoustic Guitar (nylon)"}
  0x02: {gm_patch: 33, transpose: -3, name: "Acoustic Bass"}
  0x03: {gm_patch: 75, transpose: 1, name: "Pan Flute"}
  0x04: {gm_patch: 105, transpose: -1, name: "Banjo"}
  0x05: {gm_patch: 42, transpose: -1, name: "Cello"}
  0x06: {gm_patch: 52, transpose: 0, name: "Choir Aahs"}
  0x07: {gm_patch: 73, transpose: 1, name: "Piccolo"}
  0x08: {gm_patch: 60, transpose: 0, name: "French Horn"}
  0x09: {gm_patch: 80, transpose: 0, name: "Square Lead"}
  0x0A: {gm_patch: 68, transpose: 0, name: "Oboe"}
  0x0B: {gm_patch: 17, transpose: 0, name: "Drawbar Organ"}
  0x0C: {gm_patch: 1, transpose: 0, name: "Bright Acoustic Piano"}
  0x0D: {gm_patch: 48, transpose: 0, name: "String Ensemble 1"}
  0x0E: {gm_patch: 56, transpose: -1, name: "Trumpet"}
  0x0F: {gm_patch: -42, transpose: 0, name: "Closed Hi-Hat"}  # Percussion
  0x10: {gm_patch: 104, transpose: 0, name: "Sitar"}
  0x11: {gm_patch: -46, transpose: 0, name: "Open Hi-Hat"}  # Percussion
  0x12: {gm_patch: -49, transpose: 0, name: "Crash Cymbal 1"}  # Percussion
  0x13: {gm_patch: 121, transpose: 0, name: "Breath Noise"}
  0x14: {gm_patch: -40, transpose: 0, name: "Snare Drum"}  # Percussion
  0x15: {gm_patch: -39, transpose: 0, name: "Hand Clap"}  # Percussion
  0x16: {gm_patch: 47, transpose: 0, name: "Timpani"}
  0x17: {gm_patch: 117, transpose: 0, name: "Melodic Tom"}
  0x18: {gm_patch: 32, transpose: -2, name: "Acoustic Bass"}
  0x19: {gm_patch: 45, transpose: 1, name: "Pizzicato Strings"}
  0x1A: {gm_patch: 58, transpose: -2, name: "Trombone"}
  0x1B: {gm_patch: 46, transpose: 0, name: "Orchestral Harp"}
  0x1C: {gm_patch: 34, transpose: -2, name: "Electric Bass (pick)"}
  0x1D: {gm_patch: 27, transpose: -1, name: "Electric Guitar (clean)"}
  0x1E: {gm_patch: 30, transpose: 0, name: "Distortion Guitar"}
  0x1F: {gm_patch: 78, transpose: 1, name: "Whistle"}
  0x20: {gm_patch: 11, transpose: 0, name: "Vibraphone"}
  0x21: {gm_patch: -38, transpose: 0, name: "Acoustic Snare"}  # Percussion
  0x22: {gm_patch: -35, transpose: 0, name: "Acoustic Bass Drum"}  # Percussion
  0x23: {gm_patch: -56, transpose: 0, name: "Cowbell"}  # Percussion
  0x24: {gm_patch: 14, transpose: -1, name: "Tubular Bells"}
  0x25: {gm_patch: 19, transpose: 0, name: "Church Organ"}
  0x26: {gm_patch: -78, transpose: 0, name: "Cuica"}  # Percussion (alternating 78/79)
  0x27: {gm_patch: 54, transpose: -1, name: "Synth Voice"}
  0x28: {gm_patch: 54, transpose: -1, name: "Synth Voice"}
  0x29: {gm_patch: 54, transpose: -1, name: "Synth Voice"}
  0x2A: {gm_patch: -39, transpose: 0, name: "Hand Clap"}  # Percussion
  0x2B: {gm_patch: -37, transpose: 0, name: "Side Stick"}  # Percussion
  0x2C: {gm_patch: 43, transpose: -3, name: "Contrabass"}
  0x2D: {gm_patch: -74, transpose: 0, name: "Long Guiro"}  # Percussion
  0x2E: {gm_patch: 116, transpose: 3, name: "Taiko Drum"}
  0x2F: {gm_patch: -69, transpose: 0, name: "Cabasa"}  # Percussion
  0x30: {gm_patch: 115, transpose: 3, name: "Woodblock"}
  0x31: {gm_patch: 1, transpose: 1, name: "Bright Acoustic Piano"}
  0x32: {gm_patch: 25, transpose: 0, name: "Acoustic Guitar (steel)"}
  0x33: {gm_patch: 109, transpose: 0, name: "Bagpipe"}
  0x34: {gm_patch: 77, transpose: 1, name: "Shakuhachi"}
  0x35: {gm_patch: 64, transpose: -1, name: "Soprano Sax"}
  0x36: {gm_patch: 64, transpose: 0, name: "Soprano Sax"}
  0x37: {gm_patch: -53, transpose: 0, name: "Ride Bell"}  # Percussion
  0x38: {gm_patch: 52, transpose: -1, name: "Choir Aahs"}
  0x39: {gm_patch: 52, transpose: -2, name: "Choir Aahs"}
  0x3A: {gm_patch: 52, transpose: 1, name: "Choir Aahs"}
  0x3B: {gm_patch: 19, transpose: 0, name: "Church Organ"}
  0x3C: {gm_patch: -65, transpose: 0, name: "Timbale"}  # Percussion
  0x3D: {gm_patch: -66, transpose: 0, name: "Low Timbale"}  # Percussion
  0x3E: {gm_patch: 13, transpose: 0, name: "Xylophone"}
  0x3F: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  0x40: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  0x41: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  0x42: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  0x43: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  0x44: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}

# Low patch variants (patches 0x00-0x1F when accessed directly)
patch_map_low:
  0x00: {gm_patch: 0, transpose: 0, name: "Piano"}
  0x01: {gm_patch: 6, transpose: 0, name: "Harpsichord"}
  0x02: {gm_patch: 59, transpose: 0, name: "Muted Trumpet"}
  0x03: {gm_patch: 26, transpose: 0, name: "Electric Guitar (jazz)"}
  0x04: {gm_patch: 127, transpose: 3, name: "Gunshot"}
  0x05: {gm_patch: 98, transpose: 0, name: "FX 3 (crystal)"}
  0x06: {gm_patch: 33, transpose: 1, name: "Acoustic Bass"}
  0x07: {gm_patch: 122, transpose: 0, name: "Seashore"}

# Songs list
songs:
  - {id: 0x00, title: "00"}
  - {id: 0x01, title: "Prelude"}
  - {id: 0x02, title: "Opening Theme 1"}
  - {id: 0x03, title: "Opening Theme 2"}
  - {id: 0x04, title: "Opening Theme 3"}
  - {id: 0x05, title: "Awakening"}
  - {id: 0x06, title: "Terra"}
  - {id: 0x07, title: "Shadow"}
  - {id: 0x08, title: "Strago"}
  - {id: 0x09, title: "Gau"}
  - {id: 0x0A, title: "Edgar and Sabin"}
  - {id: 0x0B, title: "Coin Song"}
  - {id: 0x0C, title: "Cyan"}
  - {id: 0x0D, title: "Locke"}
  - {id: 0x0E, title: "Forever Rachel"}
  - {id: 0x0F, title: "Relm"}
  - {id: 0x10, title: "Setzer"}
  - {id: 0x11, title: "Epitaph"}
  - {id: 0x12, title: "Celes"}
  - {id: 0x13, title: "Techno de Chocobo"}
  - {id: 0x14, title: "Decisive Battle"}
  - {id: 0x15, title: "Johnny C Bad"}
  - {id: 0x16, title: "Kefka"}
  - {id: 0x17, title: "Narshe"}
  - {id: 0x18, title: "Phantom Forest"}
  - {id: 0x19, title: "Wild West"}
  - {id: 0x1A, title: "Save Them"}
  - {id: 0x1B, title: "Emperor Gestahl"}
  - {id: 0x1C, title: "Troops March On"}
  - {id: 0x1D, title: "Under Martial Law"}
  - {id: 0x1E, title: "1E"}
  - {id: 0x1F, title: "Metamorphosis"}
  - {id: 0x20, title: "Train Starting"}
  - {id: 0x21, title: "Another World of Beasts"}
  - {id: 0x22, title: "Grand Finale 2"}
  - {id: 0x23, title: "Mt Koltz"}
  - {id: 0x24, title: "Battle"}
  - {id: 0x25, title: "Short Fanfare"}
  - {id: 0x26, title: "Wedding 1"}
  - {id: 0x27, title: "Aria de Mezzo Carattere"}
  - {id: 0x28, title: "Serpent Trench"}
  - {id: 0x29, title: "Slam Shuffle (Zozo)"}
  - {id: 0x2A, title: "Kids Run Through The City Corner"}
  - {id: 0x2B, title: "Double Question Marks"}
  - {id: 0x2C, title: "2C"}
  - {id: 0x2D, title: "Gogo"}
  - {id: 0x2E, title: "Returners"}
  - {id: 0x2F, title: "Fanfare"}
  - {id: 0x30, title: "Umaro"}
  - {id: 0x31, title: "Mog"}
  - {id: 0x32, title: "Unforgiven"}
  - {id: 0x33, title: "Fierce Battle"}
  - {id: 0x34, title: "The Day After"}
  - {id: 0x35, title: "Blackjack"}
  - {id: 0x36, title: "Catastrophe"}
  - {id: 0x37, title: "Magic House"}
  - {id: 0x38, title: "Sleep"}
  - {id: 0x39, title: "39"}
  - {id: 0x3A, title: "3A"}
  - {id: 0x3B, title: "Dancing Mad 1"}
  - {id: 0x3C, title: "3C"}
  - {id: 0x3D, title: "Spinach Rag"}
  - {id: 0x3E, title: "Rest in Peace"}
  - {id: 0x3F, title: "3F"}
  - {id: 0x40, title: "40"}
  - {id: 0x41, title: "Overture 1"}
  - {id: 0x42, title: "Overture 2"}
  - {id: 0x43, title: "Overture 3"}
  - {id: 0x44, title: "Wedding 2"}
  - {id: 0x45, title: "Wedding 3"}
  - {id: 0x46, title: "Wedding 4"}
  - {id: 0x47, title: "Devil's Lab"}
  - {id: 0x48, title: "48"}
  - {id: 0x49, title: "49"}
  - {id: 0x4A, title: "4A"}
  - {id: 0x4B, title: "New Continent"}
  - {id: 0x4C, title: "Searching for Friends"}
  - {id: 0x4D, title: "Fanatics"}
  - {id: 0x4E, title: "Last Dungeon"}
  - {id: 0x4F, title: "Dark World"}
  - {id: 0x50, title: "Dancing Mad 5"}
  - {id: 0x51, title: "51"}
  - {id: 0x52, title: "Dancing Mad 4"}
  - {id: 0x53, title: "Ending 1"}
  - {id: 0x54, title: "Ending 2"}
