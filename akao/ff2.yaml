game: "Final Fantasy II US (SNES)"
format: "snes_unified"
console_type: "snes"

# SNES ROM file
rom_file: "ff2.smc"

# Base address for song data (SNES address 04/C000)
base_address: 0x04C000

# Song pointer table configuration
song_pointer_table:
  style: "offsets" 
  offset: 0x1321d   # Offset from base_address for song pointer table
  count: 0x46        # Number of songs 

# Instrument table configuration
# Instrument table is at 04/C00F + song_id * 0x20
instrument_table_offset: 0x000F  # Offset from base_address for instrument tables

# Instrument mapping configuration
instrument_mapping:
  type: "inst_table"
  param: 0x40

# PHASE 1: Config-driven parameters for SNESUnified
spc_load_address: 0x2000   # SPC-700 RAM load address
note_divisor: 15           # Note encoding: note = cmd / 15, duration = cmd % 15
first_opcode: 0xD2         # First command opcode (< 0xD2 are notes)
rest_note_value: 12     # Note value indicating a rest (per ff2mus.pl line 182)
tie_note_value: 13      # Note value indicating a tie (per ff2mus.pl line 184)

# PHASE 2: Opcode dispatch table - maps opcode bytes to semantic meanings
opcodes:
  0xD2: {semantic: "tempo", value_param: 2}  # Tempo change (operand 2 = tempo value)
  0xD3: {semantic: "nop"}             # No operation (per ff2mus.pl)
  0xD4: {semantic: "echo_volume"}     # Echo Volume (per ff2mus.pl)
  0xD5: {semantic: "echo_settings"}   # Echo Settings (per ff2mus.pl)
  0xD6: {semantic: "portamento_on"}   # Portamento settings
  0xD7: {semantic: "tremolo_on"}      # Tremolo settings
  0xD8: {semantic: "vibrato_on"}      # Vibrato settings
  0xD9: {semantic: "pan_sweep_on"}    # Pan Sweep Settings (per ff2mus.pl)
  0xDA: {semantic: "octave_set"}      # Set octave
  0xDB: {semantic: "patch_change"}    # Patch change (uses instrument_mapping)
  0xDC: {semantic: "adsr_set"}        # Set Envelope (per ff2mus.pl)
  0xDD: {semantic: "gain_set"}        # Set Gain (Exp Dec Time) (per ff2mus.pl)
  0xDE: {semantic: "staccato_set"}    # Set Staccato (note dur ratio) (per ff2mus.pl)
  0xDF: {semantic: "noise_clock"}     # Set Noise Clock (per ff2mus.pl)
  0xE0: {semantic: "loop_start"}      # Begin repeat
  0xE1: {semantic: "octave_inc"}      # Increment octave
  0xE2: {semantic: "octave_dec"}      # Decrement octave
  0xE3: {semantic: "nop"}             # No operation (per ff2mus.pl)
  0xE4: {semantic: "nop"}             # No operation (per ff2mus.pl)
  0xE5: {semantic: "nop"}             # No operation (per ff2mus.pl)
  0xE6: {semantic: "portamento_off"}  # Portamento off
  0xE7: {semantic: "tremolo_off"}     # Tremolo off
  0xE8: {semantic: "vibrato_off"}     # Vibrato off
  0xE9: {semantic: "pan_sweep_off"}   # Pan Sweep Off (per ff2mus.pl)
  0xEA: {semantic: "echo_on"}         # Enable Echo (per ff2mus.pl)
  0xEB: {semantic: "echo_off"}        # Disable Echo (per ff2mus.pl)
  0xEC: {semantic: "noise_on"}        # Enable Noise (per ff2mus.pl)
  0xED: {semantic: "noise_off"}       # Disable Noise (per ff2mus.pl)
  0xEE: {semantic: "pitchmod_on"}     # Enable Pitchmod (per ff2mus.pl)
  0xEF: {semantic: "pitchmod_off"}    # Disable Pitchmod (per ff2mus.pl)
  0xF0: {semantic: "loop_end"}        # End repeat
  0xF1: {semantic: "halt"}            # Halt (end of track)
  0xF2: {semantic: "volume", value_param: 2}  # Voice volume (operand 2 = volume)
  0xF3: {semantic: "pan", value_param: 2}     # Voice Balance (operand 2 = pan) (per ff2mus.pl)
  0xF4: {semantic: "goto"}            # Goto address
  0xF5: {semantic: "loop_break"}      # Conditional jump/selective repeat
  0xF6: {semantic: "goto_indexed"}    # Goto 0760+X (per ff2mus.pl)
  0xF7: {semantic: "halt"}            # Halt
  0xF8: {semantic: "halt"}            # Halt
  0xF9: {semantic: "halt"}            # Halt
  0xFA: {semantic: "halt"}            # Halt
  0xFB: {semantic: "halt"}            # Halt
  0xFC: {semantic: "halt"}            # Halt
  0xFD: {semantic: "halt"}            # Halt
  0xFE: {semantic: "halt"}            # Halt
  0xFF: {semantic: "halt"}            # Halt

# Tempo calculation parameters
# BPM is calculated as: BPM = (60,000,000 * tempo_value) / tempo_factor
# where tempo_factor = timer_period_us * timer_count * tempo_resolution
timer_period_us: 4500     # Timer period in microseconds (timer0 period: 4.5ms)
timer_count: 48           # Number of timer counts per sound processing loop
tempo_resolution: 256     # 8-bit tempo operands (range 0-255)

# Default state values
default_tempo: 255
default_octave: 4
default_velocity: 64

# Duration table (SNES address 04/9738)
duration_table:
  address: 0x049738
  size: 15
  type: "byte"

# Music opcode lengths (SNES address 04/96D0)
opcode_table:
  address: 0x0496D0
  size: 46
  type: "byte"

# Pitch table (SNES address 04/96EA)
pitch_table:
  address: 0x0496EA
  size: 13
  type: "ushort"

# Patch mapping: SNES instrument -> General MIDI patch
# Negative values indicate percussion (GM drum key number)
patch_map:
  0x00: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  0x01: {gm_patch: 48, transpose: 1, name: "String Ensemble 1"}
  0x02: {gm_patch: 46, transpose: 1, name: "Orchestral Harp"}
  0x03: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  0x04: {gm_patch: 0, transpose: 1, name: "Acoustic Grand Piano"}
  0x05: {gm_patch: 19, transpose: 2, name: "Church Organ"}
  0x06: {gm_patch: 56, transpose: 0, name: "Trumpet"}
  0x07: {gm_patch: 73, transpose: 1, name: "Piccolo"}
  0x08: {gm_patch: 13, transpose: 0, name: "Xylophone"}
  0x09: {gm_patch: 34, transpose: -2, name: "Electric Bass (finger)"}
  0x0A: {gm_patch: 47, transpose: -1, name: "Timpani"}
  0x0B: {gm_patch: 43, transpose: -1, name: "Contrabass"}
  0x0C: {gm_patch: -40, transpose: 0, name: "Snare Drum"}        # Percussion
  0x0D: {gm_patch: -36, transpose: 0, name: "Bass Drum"}         # Percussion
  0x0E: {gm_patch: -38, transpose: 0, name: "Acoustic Snare"}    # Percussion
  0x0F: {gm_patch: -35, transpose: 0, name: "Acoustic Bass Drum"} # Percussion
  0x10: {gm_patch: -49, transpose: 0, name: "Crash Cymbal"}      # Percussion
  0x11: {gm_patch: -42, transpose: 0, name: "Closed Hi-Hat"}     # Percussion
  0x12: {gm_patch: 113, transpose: 0, name: "Agogo"}
  0x13: {gm_patch: -69, transpose: 0, name: "Cabasa"}            # Percussion
  0x14: {gm_patch: 85, transpose: 0, name: "Lead 6 (voice)"}
  0x15: {gm_patch: 117, transpose: 1, name: "Melodic Tom"}
  0x16: {gm_patch: -72, transpose: 0, name: "Long Whistle"}      # Percussion

# Song list
songs:
  - id: 0x00
    title: "(dummy)"
  - id: 0x01
    title: "Overture"
  - id: 0x02
    title: "Elder"
  - id: 0x03
    title: "Short Fanfare"
  - id: 0x04
    title: "11 Chocobo"
  - id: 0x05
    title: "31 Samba de Chocobo"
  - id: 0x06
    title: "Underworld"
  - id: 0x07
    title: "Zeromus"
  - id: 0x08
    title: "Victory"
  - id: 0x09
    title: "06 Welcome to our Town"
  - id: 0x0A
    title: 15 "Rydia's Theme"
  - id: 0x0B
    title: "28 Battle with Fiends"
  - id: 0x0C
    title: "19 Mountain of Ordeals"
  - id: 0x0D
    title: "07 Overworld"
  - id: 0x0E
    title: "39 Big Whale"
  - id: 0x0F
    title: "Sadness"
  - id: 0x10
    title: "Take a Nap"
  - id: 0x11
    title: "23 Golbez's Theme"
  - id: 0x12
    title: "18 Edward's Theme"
  - id: 0x13
    title: "04 Theme of Love"
  - id: 0x14
    title: "03 Kingdom of Baron"
  - id: 0x15
    title: "01 Prelude"
  - id: 0x16
    title: "Evil Golbez"
  - id: 0x17
    title: "32 Tower of Babil"
  - id: 0x18
    title: "29 Airship"
  - id: 0x19
    title: "Fiends' Theme"
  - id: 0x1A
    title: "Boss"
  - id: 0x1B
    title: "42 Giant of Babil"
  - id: 0x1C
    title: "Illusionary World"
  - id: 0x1D
    title: "14 Ring of Bombs"
  - id: 0x1E
    title: "Lunar Cave"
  - id: 0x1F
    title: "Surprise"
  - id: 0x20
    title: "Dwarf Castle"
  - id: 0x21
    title: "27 Palom and Porom"
  - id: 0x22
    title: "Calbrena"
  - id: 0x23
    title: "21 Run!!"
  - id: 0x24
    title: "24 Cid's Theme"
  - id: 0x25
    title: "12 Into the Darkness"
  - id: 0x26
    title: "Dance"
  - id: 0x27
    title: "08 Battle 1"
  - id: 0x28
    title: "16 Damcyan Castle"
  - id: 0x29
    title: "09 Fanfare"
  - id: 0x2A
    title: "17 Sorrow and Loss"
  - id: 0x2B
    title: "Chocobo Forest"
  - id: 0x2C
    title: "02 Red Wings"
  - id: 0x2D
    title: "22 Suspicion"
  - id: 0x2E
    title: "20 Fabul"
  - id: 0x2F
    title: "Cecil becomes a Paladin"
  - id: 0x30
    title: "10 Enter Big Chocobo"
  - id: 0x31
    title: "Moon"
  - id: 0x32
    title: "30 Toroian Beauty"
  - id: 0x33
    title: "25 Mysidia"
  - id: 0x34
    title: "Castle - Red Wings 2"
  - id: 0x35
    title: "Ending"
  - id: 0x36
    title: "Epilogue"
  - id: 0x37
    title: "Credits"
  - id: 0x38
    title: "(dummy)"
  - id: 0x39
    title: "(dummy)"
  - id: 0x3A
    title: "(dummy)"
  - id: 0x3B
    title: "(dummy)"
  - id: 0x3C
    title: "(dummy)"
  - id: 0x3D
    title: "(dummy)"
  - id: 0x3E  
    title: "??"
  - id: 0x3F  
    title: "Gongs and Foghorn?"
  - id: 0x40  
    title: "Door open?"
  - id: 0x41  
    title: "Door open?"
  - id: 0x42  
    title: "Earthquake"
  - id: 0x43  
    title: "Fall Down"
  - id: 0x44  
    title: "Leviathan Rises"
  - id: 0x45  
    title: "(dummy)"
