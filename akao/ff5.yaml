game: "Final Fantasy V (SNES)"
format: "snes_unified"
console_type: "snes"

# SNES ROM file
rom_file: "ff5e.smc"

# Base address for song data (SNES address C4/0000 - HiROM)
base_address: 0xC40000

# Song pointer table configuration
song_pointer_table:
  style: "direct"  # FF3 uses direct pointers (vs FF2's indirection table)
  offset: 0x3b97   # Offset from base_address
  count: 72        # Number of songs

#has_alternate_voice_pointers: true  # Some songs have alternate versions

# Instrument table configuration
instrument_table_offset: 0x3daa  # Offset from base_address for instrument tables

# Instrument mapping configuration
instrument_mapping:
  type: "dual_map"
  param: 0x20

# PHASE 1: Config-driven parameters for SNESUnified
spc_load_address: 0x1C00   # SPC-700 RAM load address (different from FF2's 0x2000)
note_divisor: 15           # Note encoding: note = cmd / 14, duration = cmd % 14 (different from FF2's 15)
first_opcode: 0xD2         # First command opcode (< 0xC4 are notes, different from FF2's 0xD2)
vptr_offset:  2            # offset of voice pointers in song data (per sommus.pl line 104)

# Voice addressing formula for FF3
vaddroffset_formula:
  type: "subtract_constant"
  constant: 0x11C14
  emptyvoice_offset: 0x12 # offset of emptyvoice field in song data      

# PHASE 2: Opcode dispatch table - maps opcode bytes to semantic meanings
# FF5 similar to SOM
opcodes:
  0xD2: {semantic: "volume"}          # Voice volume (per sommus.pl line 197)
  0xD3: {semantic: "volume_fade"}     # Volume fade (per sommus.pl line 205)
  0xD4: {semantic: "pan"}             # Balance/pan (per sommus.pl line 224)
  0xD5: {semantic: "pan_fade"}        # Balance/pan fade (per sommus.pl line 228)
  0xD6: {semantic: "portamento_on"}   # Portamento (unimplemented in Perl)
  0xD7: {semantic: "vibrato_on"}      # Vibrato (unimplemented in Perl)
  0xD8: {semantic: "vibrato_off"}     # Vibrato off (unimplemented in Perl)
  0xD9: {semantic: "tremolo_on"}      # Tremolo (unimplemented in Perl)
  0xDA: {semantic: "tremolo_off"}     # Tremolo off (unimplemented in Perl)
  0xDB: {semantic: "pan_sweep_on"}    # Pan Sweep (unimplemented in Perl)
  0xDC: {semantic: "pan_sweep_off"}   # Pan Sweep off (unimplemented in Perl)
  0xDD: {semantic: "noise_clock"}     # Set Noise Clock (unimplemented in Perl)
  0xDE: {semantic: "noise_on"}        # Enable Noise (unimplemented in Perl)
  0xDF: {semantic: "noise_off"}       # Disable Noise (unimplemented in Perl)
  0xE0: {semantic: "pitchmod_on"}     # Enable Pitchmod (unimplemented in Perl)
  0xE1: {semantic: "pitchmod_off"}    # Disable Pitchmod (unimplemented in Perl)
  0xE2: {semantic: "echo_on"}         # Enable Echo (unimplemented in Perl)
  0xE3: {semantic: "echo_off"}        # Disable Echo (unimplemented in Perl)
  0xE4: {semantic: "octave_set"}      # Set octave (per sommus.pl line 277)
  0xE5: {semantic: "octave_inc"}      # Increment octave (per sommus.pl line 279)
  0xE6: {semantic: "octave_dec"}      # Decrement octave (per sommus.pl line 282)
  0xE7: {semantic: "transpose_set"}   # Set transpose (per sommus.pl line 272)
  0xE8: {semantic: "transpose_change"} # Change transpose (per sommus.pl line 274)
  0xE9: {semantic: "detune"}          # Detune (unimplemented in Perl)
  0xEA: {semantic: "patch_change"}  # Patch change (uses instrument_mapping)
  0xEB: {semantic: "adsr_attack"}     # ADSR Attack (unimplemented in Perl)
  0xEC: {semantic: "adsr_decay"}      # ADSR Decay (unimplemented in Perl)
  0xED: {semantic: "adsr_sustain"}    # ADSR Sustain (unimplemented in Perl)
  0xEE: {semantic: "adsr_release"}    # ADSR Release (unimplemented in Perl)
  0xEF: {semantic: "adsr_default"}    # Default ADSR (unimplemented in Perl)
  0xF0: {semantic: "loop_start"}      # Begin repeat (per sommus.pl line 292)
  0xF1: {semantic: "loop_end"}        # End repeat (per sommus.pl line 296)
  0xF2: {semantic: "halt"}            # Halt (per sommus.pl line 327)
  0xF3: {semantic: "tempo"}           # Tempo change (per sommus.pl line 177)
  0xF4: {semantic: "tempo_fade"}      # Tempo fade (per sommus.pl line 183)
  0xF5: {semantic: "echo_volume"}     # Echo Volume (unimplemented in Perl)
  0xF6: {semantic: "echo_volume_fade"} # Echo Volume Fade (unimplemented in Perl)
  0xF7: {semantic: "echo_feedback"}   # Echo Feedback (unimplemented in Perl)
  0xF8: {semantic: "master_volume"}   # Set master volume (per sommus.pl line 286)
  0xF9: {semantic: "loop_break", handler: "vaddroffset"}  # Conditional loop (per sommus.pl line 322)
  0xFA: {semantic: "goto", handler: "vaddroffset"}        # Goto with vaddroffset (per sommus.pl line 305)
  0xFB: {semantic: "goto_if_c4"}  # conditional goto based on memory c4 (actually d1 for ff5)
  0xFC: {semantic: "halt"}      # Reset conditional repeat counter (per sommus.pl line 320)
  0xFD: {semantic: "halt"}            # Halt (unimplemented in Perl)
  0xFE: {semantic: "halt"}            # Halt (per sommus.pl line 327)
  0xFF: {semantic: "halt"}            # Halt (per sommus.pl line 327)

# Tempo calculation parameters
# BPM is calculated as: BPM = (60,000,000 * tempo_value) / tempo_factor
# where tempo_factor = timer_period_us * timer_count * tempo_resolution
timer_period_us: 4500     # Timer period in microseconds (timer0 period: 4.5ms)
timer_count: 48           # Number of timer counts per sound processing loop
tempo_resolution: 256     # 8-bit tempo operands (range 0-255)

# Default state values
default_tempo: 120
default_octave: 4
default_velocity: 100

# Duration table
duration_table:
  address: 0xC41D7E  # spcbase + 0x192f where spcbase = C4/044F
  size: 15
  type: "byte"

# Music opcode lengths - 60 opcodes starting from 0xC4
opcode_table:
  address: 0xC41CD6 # spcbase + 0x1887 where spcbase = C4/044F
  size: 46
  type: "byte"

# Pitch table
pitch_table:
  address: 0xC41D44  # spcbase + 0x18f5 where spcbase = C4/044F
  size: 13
  type: "ushort"

# Patch mapping: instrument_id -> General MIDI patch
# Negative values indicate percussion (GM drum key number)
patch_map:
  0x00: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  # 0x01: {gm_patch: 24, transpose: 0, name: "Acoustic Guitar (nylon)"}
  # 0x02: {gm_patch: 33, transpose: -3, name: "Acoustic Bass"}
  # 0x03: {gm_patch: 75, transpose: 1, name: "Pan Flute"}
  # 0x04: {gm_patch: 105, transpose: -1, name: "Banjo"}
  # 0x05: {gm_patch: 42, transpose: -1, name: "Cello"}
  # 0x06: {gm_patch: 52, transpose: 0, name: "Choir Aahs"}
  # 0x07: {gm_patch: 73, transpose: 1, name: "Piccolo"}
  # 0x08: {gm_patch: 60, transpose: 0, name: "French Horn"}
  # 0x09: {gm_patch: 80, transpose: 0, name: "Square Lead"}
  # 0x0A: {gm_patch: 68, transpose: 0, name: "Oboe"}
  0x11: {gm_patch: 17, transpose: 0, name: "Drawbar Organ"}
  # 0x0C: {gm_patch: 1, transpose: 0, name: "Bright Acoustic Piano"}
  0x0B: {gm_patch: 48, transpose: 0, name: "String Ensemble 1"}
  0x0E: {gm_patch: 56, transpose: 0, name: "Trumpet"}
  # 0x0F: {gm_patch: -42, transpose: 0, name: "Closed Hi-Hat"}  # Percussion
  # 0x10: {gm_patch: 104, transpose: 0, name: "Sitar"}
  # 0x11: {gm_patch: -46, transpose: 0, name: "Open Hi-Hat"}  # Percussion
  # 0x12: {gm_patch: -49, transpose: 0, name: "Crash Cymbal 1"}  # Percussion
  # 0x13: {gm_patch: 121, transpose: 0, name: "Breath Noise"}
  # 0x14: {gm_patch: -40, transpose: 0, name: "Snare Drum"}  # Percussion
  # 0x15: {gm_patch: -39, transpose: 0, name: "Hand Clap"}  # Percussion
  # 0x16: {gm_patch: 47, transpose: 0, name: "Timpani"}
  # 0x17: {gm_patch: 117, transpose: 0, name: "Melodic Tom"}
  # 0x14: {gm_patch: 32, transpose: -2, name: "Acoustic Bass"}
  # 0x19: {gm_patch: 45, transpose: 1, name: "Pizzicato Strings"}
  # 0x1A: {gm_patch: 58, transpose: -2, name: "Trombone"}
  0x0D: {gm_patch: 46, transpose: 0, name: "Orchestral Harp"}
  0x14: {gm_patch: 34, transpose: -2, name: "Electric Bass (pick)"}
  # 0x1D: {gm_patch: 27, transpose: -1, name: "Electric Guitar (clean)"}
  # 0x1E: {gm_patch: 30, transpose: 0, name: "Distortion Guitar"}
  # 0x1F: {gm_patch: 78, transpose: 1, name: "Whistle"}
  # 0x20: {gm_patch: 11, transpose: 0, name: "Vibraphone"}
  0x02: {gm_patch: -38, transpose: 0, name: "Acoustic Snare"}  # Percussion
  0x01: {gm_patch: -35, transpose: 0, name: "Acoustic Bass Drum"}  # Percussion
  # 0x23: {gm_patch: -56, transpose: 0, name: "Cowbell"}  # Percussion
  # 0x24: {gm_patch: 14, transpose: -1, name: "Tubular Bells"}
  # 0x25: {gm_patch: 19, transpose: 0, name: "Church Organ"}
  # 0x26: {gm_patch: -78, transpose: 0, name: "Cuica"}  # Percussion (alternating 78/79)
  # 0x27: {gm_patch: 54, transpose: -1, name: "Synth Voice"}
  # 0x28: {gm_patch: 54, transpose: -1, name: "Synth Voice"}
  # 0x29: {gm_patch: 54, transpose: -1, name: "Synth Voice"}
  # 0x2A: {gm_patch: -39, transpose: 0, name: "Hand Clap"}  # Percussion
  # 0x2B: {gm_patch: -37, transpose: 0, name: "Side Stick"}  # Percussion
  # 0x2C: {gm_patch: 43, transpose: -3, name: "Contrabass"}
  # 0x2D: {gm_patch: -74, transpose: 0, name: "Long Guiro"}  # Percussion
  # 0x2E: {gm_patch: 116, transpose: 3, name: "Taiko Drum"}
  # 0x2F: {gm_patch: -69, transpose: 0, name: "Cabasa"}  # Percussion
  # 0x30: {gm_patch: 115, transpose: 3, name: "Woodblock"}
  # 0x31: {gm_patch: 1, transpose: 1, name: "Bright Acoustic Piano"}
  # 0x32: {gm_patch: 25, transpose: 0, name: "Acoustic Guitar (steel)"}
  # 0x33: {gm_patch: 109, transpose: 0, name: "Bagpipe"}
  # 0x34: {gm_patch: 77, transpose: 1, name: "Shakuhachi"}
  # 0x35: {gm_patch: 64, transpose: -1, name: "Soprano Sax"}
  # 0x36: {gm_patch: 64, transpose: 0, name: "Soprano Sax"}
  # 0x37: {gm_patch: -53, transpose: 0, name: "Ride Bell"}  # Percussion
  # 0x38: {gm_patch: 52, transpose: -1, name: "Choir Aahs"}
  # 0x39: {gm_patch: 52, transpose: -2, name: "Choir Aahs"}
  # 0x3A: {gm_patch: 52, transpose: 1, name: "Choir Aahs"}
  # 0x3B: {gm_patch: 19, transpose: 0, name: "Church Organ"}
  # 0x3C: {gm_patch: -65, transpose: 0, name: "Timbale"}  # Percussion
  # 0x3D: {gm_patch: -66, transpose: 0, name: "Low Timbale"}  # Percussion
  # 0x3E: {gm_patch: 13, transpose: 0, name: "Xylophone"}
  # 0x3F: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  # 0x40: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  # 0x41: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  # 0x42: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  # 0x43: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}
  # 0x44: {gm_patch: 0, transpose: 0, name: "Acoustic Grand Piano"}

# Low patch variants (patches 0x00-0x1F when accessed directly)
patch_map_low:
  0x00: {gm_patch: 0, transpose: 0, name: "Piano"}
  # 0x01: {gm_patch: 6, transpose: 0, name: "Harpsichord"}
  # 0x02: {gm_patch: 59, transpose: 0, name: "Muted Trumpet"}
  # 0x03: {gm_patch: 26, transpose: 0, name: "Electric Guitar (jazz)"}
  # 0x04: {gm_patch: 127, transpose: 3, name: "Gunshot"}
  # 0x05: {gm_patch: 98, transpose: 0, name: "FX 3 (crystal)"}
  # 0x06: {gm_patch: 33, transpose: 1, name: "Acoustic Bass"}
  # 0x07: {gm_patch: 122, transpose: 0, name: "Seashore"}

# Songs list
songs:
  - {id: 0x00, title: "1.01 Ahead on Our Way"}
  - {id: 0x01, title: "1.19 The Fierce Battle"}
  - {id: 0x02, title: "1.02 A Presentiment"}
  - {id: 0x03, title: "2.10 Go go Boco!"}
  - {id: 0x04, title: "1.10 Pirates Ahoy!"}
  - {id: 0x05, title: "1.11 Tenderness in the Air"}
  - {id: 0x06, title: "1.06 Fate in haze"}
  - {id: 0x07, title: "2.05 Critter Tripper Fritter!"}
  - {id: 0x08, title: "2.22 The Prelude"}
  - {id: 0x09, title: "2.17 The Last Battle"}
  - {id: 0x0A, title: "1.09 Requiem"}
  - {id: 0x0B, title: "1.24 Nostalgia"}
  - {id: 0x0C, title: "1.14 Cursed Earth"}
  - {id: 0x0D, title: "1.05 Lenna's Theme"}
  - {id: 0x0E, title: "1.08 Victory's Fanfare"}
  - {id: 0x0F, title: "1.15 Deception"}
  - {id: 0x10, title: "1.28 The Day Will Come"}
  - {id: 0x11, title: "Unknown"}
  - {id: 0x12, title: "2.01 Exdeath's Castle"}
  - {id: 0x13, title: "1.31 My Home Sweet Home"}
  - {id: 0x14, title: "2.09 Waltz Suomi"}
  - {id: 0x15, title: "1.13 Sealed Away"}
  - {id: 0x16, title: "2.02 The Four Warriors of Dawn"}
  - {id: 0x17, title: "1.18 Danger!"}
  - {id: 0x18, title: "1.22 The Fire Powered Ship"}
  - {id: 0x19, title: "2.08 As I Feel, You Feel"}
  - {id: 0x1A, title: "1.30 Mambo de Chocobo"}
  - {id: 0x1B, title: "1.32 Music Box"}
  - {id: 0x1C, title: "2.13 Intention of the Earth"}
  - {id: 0x1D, title: "1.20 The Dragon Spreads Its Wings"}
  - {id: 0x1E, title: "2.07 Beyond the Deep Blue Sea"}
  - {id: 0x1F, title: "2.14 Prelude of the Empty Skies"}
  - {id: 0x20, title: "2.15 Searching the Light"}
  - {id: 0x21, title: "1.16 Harvest"}
  - {id: 0x22, title: "2.03 Battle with Gilgamesh"}
  - {id: 0x23, title: "1.03 Four valiant hearts"}
  - {id: 0x24, title: "2.12 The Book of Sealings"}
  - {id: 0x25, title: "1.29 What"}
  - {id: 0x26, title: "1.04 Hurry! Hurry!"}
  - {id: 0x27, title: "2.04 Unknown Lands"}
  - {id: 0x28, title: "1.33 The Airship"}
  - {id: 0x29, title: "2.23 Fanfare 1"}
  - {id: 0x2A, title: "2.24 Fanfare 2"}
  - {id: 0x2B, title: "1.07 The Battle"}
  - {id: 0x2C, title: "1.17 Walking the Snowy Mountains"}
  - {id: 0x2D, title: "1.34 The Evil Lord Exdeath"}
  - {id: 0x2E, title: "2.06 The Castle of Dawn"}
  - {id: 0x2F, title: "2.25 I'm a Dancer"}
  - {id: 0x30, title: "1.26 Reminiscence"}
  - {id: 0x31, title: "1.23 Run!"}
  - {id: 0x32, title: "1.25 The Ancient Library"}
  - {id: 0x33, title: "1.21 Royal Palace"}
  - {id: 0x34, title: "1.12 Good Night!"}
  - {id: 0x35, title: "2.26 Piano Lesson 1"}
  - {id: 0x36, title: "2.27 Piano Lesson 2"}
  - {id: 0x37, title: "2.28 Piano Lesson 3"}
  - {id: 0x38, title: "2.29 Piano Lesson 4"}
  - {id: 0x39, title: "2.30 Piano Lesson 5"}
  - {id: 0x3A, title: "2.31 Piano Lesson 6"}
  - {id: 0x3B, title: "2.32 Piano Lesson 7"}
  - {id: 0x3C, title: "2.33 Piano Lesson 8"}
  - {id: 0x3D, title: "1.27 Musica Machina"}
  - {id: 0x3E, title: "Unknown"}
  - {id: 0x3F, title: "2.11 The Land Unknown"}
  - {id: 0x40, title: "2.16 The Decisive Battle"}
  - {id: 0x41, title: "2.18 The Silent Beyond"}
  - {id: 0x42, title: "2.19 Dear Friends"}
  - {id: 0x43, title: "2.20 Final Fantasy"}
  - {id: 0x44, title: "2.21 A New Origin"}
  - {id: 0x45, title: "Unknown"}
  - {id: 0x46, title: "Unknown"}
  - {id: 0x47, title: "Unknown"}
